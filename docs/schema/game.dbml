Enum case_status {
  RUNNING
  ENDED
}

Enum team {
  UNASSIGNED
  RED
  BLUE
}

Enum team_setting {
  RANDOM
  FIXED
}

Enum phase_type {
  NIGHT
  DISCUSS
  VOTE
}

Enum phase_state {
  OPEN
  CLOSED
  RESOLVED
}

Table users {
  id uuid [pk]
  username varchar(255) [unique, not null, note: "login identifier"]
  created_at timestamptz [not null, default: `now()`]
}

Table rooms {
  id uuid [pk]
  room_name varchar(255)
  host_id uuid [ref: > users.id, not null]
  created_at timestamptz [not null, default: `now()`]
}

Table room_settings {
  room_id uuid [pk, ref: > rooms.id]
  max_players int [not null, default: 8, note: ">=4"]
  team_policy team_setting [not null, default: RANDOM]
  full_life int [not null, note: ">=1"]
  night_duration_sec int [not null, default: 30, note: ">=1"]
  vote_duration_sec int [not null, default: 30, note: ">=1"]
  discuss_duration_sec int [not null, default: 150, note: ">=0, 0이면 무제한"]
}

Table room_members {
  room_id uuid [pk, ref: > rooms.id, not null]
  user_id uuid [pk, ref: > users.id, not null]
  joined_at timestamptz [not null, default: `now()`]
  left_at timestamptz

  indexes {
    room_id
    user_id
  }
}

Table cases {
  id uuid [pk]
  room_id uuid [ref: > rooms.id, not null]
  status case_status [not null, default: RUNNING]
  current_round_no int [not null, default: 1]
  current_phase_id uuid [ref: > phases.id, default: null, note: "case 생성 직후, phase 생성 이전"]
  created_at timestamptz [not null, default: `now()`]
  updated_at timestamptz [not null, default: `now()`]

  Note: "Constraint: 하나의 room에 하나의 RUNNING case만 가지도록 partial unique index 걸어야 함."
}

Table case_settings {
  case_id uuid [pk, ref: > cases.id]
  max_players int [not null, default: 8, note: ">=4"]
  team_policy team_setting [not null]
  full_life int [not null, note: ">=1"]
  night_duration_sec int [not null, default: 30, note: ">=1"]
  vote_duration_sec int [not null, default: 30, note: ">=1"]
  discuss_duration_sec int [not null, default: 150, note: ">=0, 0이면 무제한"]
}

Table case_players {
  id uuid [pk]
  case_id uuid [ref: > cases.id, not null]
  user_id uuid [ref: > users.id, not null]
  seat_no int [not null, note: "start from 0"]
  team team [not null]
  life_lost int [not null, note: ">=0"]

  indexes {
    case_id
    (case_id, user_id) [unique]
    (case_id, seat_no) [unique]
  }
}

Table phases {
  id uuid [pk]
  case_id uuid [ref: > cases.id, not null]
  round_no int [not null]
  seq_in_round int [not null]
  phase_type phase_type [not null]
  state phase_state [not null, default: OPEN]
  opened_at timestamptz [not null, default: `now()`]
  closed_at timestamptz
  resolved_at timestamptz

  indexes {
    (case_id, round_no)
    (case_id, round_no, seq_in_round) [unique]
  }
}

Table votes {
  id uuid [pk]
  phase_id uuid [ref: > phases.id, not null]
  voter_player_id uuid [ref: > case_players.id, not null]
  target_player_id uuid [ref: > case_players.id, not null]
  cast_at timestamptz [not null, default: `now()`]

  indexes {
    phase_id
    (phase_id, voter_player_id) [unique, note: "first vote only"]
  }
}

Table phase_readies {
  phase_id uuid [pk, not null, ref: > phases.id]
  player_id uuid [pk, not null, ref: > case_players.id]
  ready_at timestamptz [not null, default: `now()`]

  indexes {
    phase_id
  }
}
